<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>看谁翻得快</title>
    <link href="./apis.css" rel="stylesheet"/>
</head>

<body>
    <div class="container">
        <div class="title">点击卡牌来翻转牌面，两张相同图案的卡牌即可保留，游戏计时将在卡牌翻转之后开始，完全翻转所有卡牌则计时结束</div>
        <div id="time"><span id="timeText">计时未开始</span></div>
        <div id="box">
            <div class="left"></div>
            <div class="right"></div>
        </div>
        <button id="startBtn" onclick="start()" class="start-btn">开始</button>
        <button id="restartBtn" onclick="restart()" class="start-btn">重新开始</button>
    </div>
    
    <script src="./jquery.min.js"></script>
    <script>
        /** 参考: https://juejin.cn/post/7152399177723412511 */

        const imgSrc = [
            'https://c2.im5i.com/2022/10/11/TSRES.png',
            'https://c2.im5i.com/2022/10/11/TSXAD.png',
            'https://c2.im5i.com/2022/10/11/TSWHP.png',
            'https://c2.im5i.com/2022/10/11/TSTG2.png',
            'https://c2.im5i.com/2022/10/11/TSHa7.png',
            'https://c2.im5i.com/2022/10/11/TS59l.png',
            'https://c2.im5i.com/2022/10/11/TSuln.png',
            'https://c2.im5i.com/2022/10/11/TSt11.png',
            'https://c2.im5i.com/2022/10/11/TSyG6.png',
            'https://c2.im5i.com/2022/10/11/TSsqw.png',
            'https://c2.im5i.com/2022/10/11/TSEsZ.png',
            'https://c2.im5i.com/2022/10/11/TSJAU.png',
        ]

        const COUNT_DOWN = 5

        var len = imgSrc.length
        var left_Map = {}
        var right_Map = {}
        var cache = []
        var findNum = 0
        var timeText = 0
        var timer = null;

        function reset() {
            left_Map = {}
            right_Map = {}
            cache = []
            findNum = 0
            timeText = 0
            if(timer) {
                clearInterval(timer)
            }
            timer = null
            $('.left').html('')
            $('.right').html('')
        }
        
        function randomKey (map, from) {
            let key = null
            do {
                key = Math.floor(Math.random() * len)
            } while (map[key])

            let div = $('<div>')
            div.addClass('item')
            div.addClass('shine')
            div.attr('key', key)
            div.css('background-image', `url(${imgSrc[key]})`)
            map[key] = div
            $(`.${from}`).append(div)          
        }

        function initBackground() {
            return new Promise((resolve, reject) => {
                for(let i = 0;i < imgSrc.length; i++) {
                    randomKey(left_Map, 'left')
                    randomKey(right_Map, 'right')
                }

                resolve()
            })
        }

        function closeBackground() {
            return new Promise((resolve, reject) => {
                for(let i in left_Map) {
                    left_Map[i].removeClass('shine')
                    left_Map[i].css('background-image', `url(https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0a4ce25d48b8405cbf5444b6195928d4~tplv-k3u1fbpfcp-no-mark:0:0:0:0.awebp)`)
                }
                for(let i in right_Map) {
                    right_Map[i].removeClass('shine')
                    right_Map[i].css('background-image', `url(https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0a4ce25d48b8405cbf5444b6195928d4~tplv-k3u1fbpfcp-no-mark:0:0:0:0.awebp)`)
                }
                resolve()
            })
        }

        function openBackground() {
            return new Promise((resolve, reject) => {
                for(let i in left_Map) {
                    left_Map[i].addClass('shine')
                    let key = jQuery(left_Map[i]).attr("key")
                    left_Map[i].css('background-image', `url(${imgSrc[key]})`)
                }
                for(let i in right_Map) {
                    right_Map[i].addClass('shine')
                    let key = jQuery(right_Map[i]).attr("key")
                    right_Map[i].css('background-image', `url(${imgSrc[key]})`)
                }
                resolve()
            })
        }

        initBackground().then(closeBackground())
        $('#restartBtn').hide()

        function start() {
            $('#startBtn').hide()
            $('#restartBtn').hide()
            toStart()
        }

        function toStart() {
            initItem().then(openBackground()).then(() => {
                let countDown = COUNT_DOWN
                $('#timeText').html('倒计时' + countDown + '秒后开始')
                timer = setInterval(() => {
                    countDown--
                    if (countDown === 0) {
                        clearInterval(timer)
                        let time = new Date().getTime()
                        timer = setInterval(() => {
                            timeText = (new Date().getTime() - time) / 1000
                            $('#timeText').text(timeText)
                            $('#timeText').after().append('秒')
                        }, 100)

                        closeBackground()
                        $('#restartBtn').show()
                    } else {
                        $('#timeText').html('倒计时' + countDown + '秒后开始')
                    }
                }, 1000)
            })
        }

        function initItem() {
            return new Promise((resolve, reject) => {
                $('.item').click(function () {
                    if ($(this).hasClass('shine')) {
                        return false
                    }
                    let key = Number($(this).attr('key'))
                    $(this).addClass('shine')
                    $(this).css('background-image', `url(${imgSrc[key]})`)
                    if (cache.length === 1) {
                        if (cache.find(v => v === key) !== undefined) {
                            cache = []
                            findNum++
                            console.log("findNum====", findNum)
                            if (findNum >= 12) {
                                clearInterval(timer)
                                $('#timeText').text('游戏结束，用时' + timeText)
                            }
                            return false
                        } else {
                            // 加一个人为延时，处理已经翻转但配对不成功的两个牌面，并清空cache缓存
                            let self = this
                            let inx = cache[0]
                            cache = []
                            let tm = setTimeout(function () {
                                $(`.item[key=${inx}]`).removeClass('shine')
                                $(`.item[key=${inx}]`).css('background-image', `url(https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0a4ce25d48b8405cbf5444b6195928d4~tplv-k3u1fbpfcp-no-mark:0:0:0:0.awebp)`)
                                $(self).removeClass('shine')
                                $(self).css('background-image', `url(https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0a4ce25d48b8405cbf5444b6195928d4~tplv-k3u1fbpfcp-no-mark:0:0:0:0.awebp)`)
                            }, 500)
                        }
                    } else {
                        cache.push(key)
                    }

                })

                resolve()
            })            
        }

        function restart() {
            reset()
            initBackground()
                .then(closeBackground())
                .then(start())
        }

    </script>
  </body>
</html>